<!DOCTYPE html>
<html>

<head>
    <meta property="article:published_time" content="2025-02-16T09:07:00.000Z" />
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; line-height: 1.6; color: #1a1a1a; background-color: #ffffff; margin: 0; padding: 0;">
  <main style="max-width: 760px; margin: 0 auto; padding: 40px 20px;">
    <article>
      <style>
        h1, h2 {
          color: #111827;
          margin-top: 1.8em;
          margin-bottom: 0.5em;
          line-height: 1.3;
        }
        h1 {
          font-size: 2rem;
          font-weight: 700;
        }
        h2 {
          font-size: 1.3rem;
          font-weight: 600;
          border-left: 4px solid #2f6feb;
          padding-left: 8px;
        }
        p {
          font-size: 1.05rem;
          margin: 1em 0;
        }
        ul {
          margin: 0.5em 0 1.5em 1.2em;
        }
        li {
          margin-bottom: 0.5em;
        }
        pre {
          background: #f9fafb;
          border-radius: 8px;
          padding: 12px 14px;
          overflow-x: auto;
          border: 1px solid #e5e7eb;
          font-size: 0.95rem;
          line-height: 1.5;
        }
        code {
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
          background: #f3f4f6;
          border-radius: 4px;
          padding: 1px 4px;
        }
        .pw-post-body-paragraph {
          margin-bottom: 1.3em;
        }
        a {
          color: #2563eb;
          text-decoration: none;
        }
        a:hover {
          text-decoration: underline;
        }
        em {
          color: #374151;
        }
      </style>

      <section>
        <div class="pw-post-title">
          <h1>The Secret Key That Saves You From Paying Twice: Understanding Idempotency in APIs</h1>
        </div>

        <p class="pw-post-body-paragraph">
          When you hit <strong>Pay</strong> and the network freezes, your phone or gateway might resend the request. 
          Without protection, you could get charged twice. The fix? 
          <strong>Idempotency keys</strong> ‚Äî a small concept that prevents big financial disasters.
        </p>

        <h2>üß† What is an Idempotency Key?</h2>
        <p class="pw-post-body-paragraph">
          An <strong>idempotency key</strong> is a unique identifier (usually a UUIDv4) that represents one user intent. 
          If the same key is sent again, the server returns the original response instead of performing the action twice.
        </p>

        <pre><code>POST /v1/payments
Idempotency-Key: 9e1a0d0f-12e5-4b6a-84d9-cc1f3c2e3f91
{
  "amount": 50000,
  "currency": "INR",
  "method": "UPI"
}</code></pre>

        <h2>‚öôÔ∏è How It Works</h2>
        <ul>
          <li>Client generates a UUIDv4 key per intent.</li>
          <li>Server checks if the key already exists.</li>
          <li>If not found ‚Üí process and store result.</li>
          <li>If found ‚Üí return stored response.</li>
        </ul>

        <h2>üíª Java Example (Spring Boot)</h2>
        <pre><code>@RestController
@RequestMapping("/v1")
public class PaymentController {
  @Autowired private IdempotencyService idem;
  @Autowired private PaymentService payments;

  @PostMapping("/payments")
  public ResponseEntity<?> create(@RequestBody PaymentReq req, 
                                  @RequestHeader("Idempotency-Key") String key) {
    String fp = Fingerprint.of("POST", "/v1/payments", req);
    return idem.withIdem(key, fp, () -> {
      PaymentResult r = payments.charge(req);
      return ResponseEntity.status(201).body(r);
    });
  }
}</code></pre>

        <h2>üêç Python Example (FastAPI)</h2>
        <pre><code>@app.post("/v1/payments")
async def create_payment(req: dict, idem_key: str = Header(..., alias="Idempotency-Key")):
    fp = hash(json.dumps(req, sort_keys=True))
    cached = await redis.get(idem_key)
    if cached:
        return JSONResponse(status_code=200, content=json.loads(cached))
    result = {"charge_id": "ch_123", **req}
    await redis.set(idem_key, json.dumps(result), ex=3600)
    return JSONResponse(status_code=201, content=result)</code></pre>

        <h2>üö® Common Mistakes</h2>
        <ul>
          <li>‚ùå Using the same key for different requests.</li>
          <li>‚ùå Forgetting TTL ‚Äî always expire old keys.</li>
          <li>‚ùå Not caching error responses (causes retry storms).</li>
        </ul>

        <h2>‚úÖ Best Practices</h2>
        <ul>
          <li>Generate UUIDv4 keys on the client.</li>
          <li>Store <code>(key, fingerprint, response, expiry)</code>.</li>
          <li>Use Redis for performance, DB for audit trail.</li>
          <li>Return <strong>201</strong> for first success, <strong>200</strong> for replays.</li>
        </ul>

        <p class="pw-post-body-paragraph">
          Idempotency is the silent guardian of reliability. 
          It makes your APIs safe to retry ‚Äî turning chaos into calm.
        </p>

        <p class="pw-post-body-paragraph">
          <em>‚ÄúEvery POST that spends money deserves an idempotency key.‚Äù</em>
        </p>

      </section>
    </article>
  </main>
</body>


</html>
